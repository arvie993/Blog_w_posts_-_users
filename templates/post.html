{% from "bootstrap5/form.html" import render_form %}
{% include "header.html" %}

<!-- Page Header-->
<header class="masthead" style="background-image: url('{{post.img_url}}')">
  <div class="container position-relative px-4 px-lg-5">
    <div class="row gx-4 gx-lg-5 justify-content-center">
      <div class="col-md-10 col-lg-8 col-xl-7">
        <div class="post-heading">
          <h1>{{ post.title }}</h1>
          <h2 class="subheading">{{ post.subtitle }}</h2>
          <span class="meta"
            >Posted by
            <a href="#">{{ post.author.name }}</a>
            on {{ post.date }}
          </span>
        </div>
      </div>
    </div>
  </div>
</header>

<!-- Post Content -->
<article>
  <div class="container px-4 px-lg-5">
    <div class="row gx-4 gx-lg-5 justify-content-center">
      <div class="col-md-10 col-lg-8 col-xl-7">
        {{ post.body|safe }}
        {% if current_user.id == 1 %}
        <div class="d-flex justify-content-end mb-4">
          <a
            class="btn btn-primary float-right"
            href="{{url_for('edit_post', post_id=post.id)}}"
            >Edit Post</a
          >
        </div>
        {% endif %}

        <!-- Comments Area -->
        <!-- CKEditor for commenting - Using secure version -->
        <script src="https://cdn.ckeditor.com/4.25.1-lts/standard/ckeditor.js"></script>
        {{ ckeditor.config(name='comment_text') }}
        
        <form id="commentForm" method="POST" action="{{ url_for('show_post', post_id=post.id) }}">
          {{ form.csrf_token }}
          <div class="mb-3">
            {{ form.comment_text.label(class="form-label") }}
            {{ form.comment_text(class="form-control ckeditor") }}
          </div>
          <button type="submit" class="btn btn-primary" id="commentSubmitBtn">
            <span id="commentSubmitText">Submit Comment</span>
            <span id="commentSpinner" class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
          </button>
        </form>

        <div class="comment">
          <!-- Show all the comments on a post -->
          <ul class="commentList" id="commentList">
            {% for comment in post.comments %}
            <li id="comment-{{ comment.id }}">
              <div class="commenterImage">
                <img src="{{ comment.comment_author.email | gravatar }}" />
              </div>
              <div class="commentText">
                {{ comment.text|safe }}
                <span class="date sub-text">
                  {{ comment.comment_author.name }}
                  {% if current_user.is_authenticated and (current_user.id == comment.author_id or current_user.id == 1) %}
                  <a href="#" 
                     class="text-danger ms-2 delete-comment" 
                     data-comment-id="{{ comment.id }}"
                     title="Delete comment">
                    <i class="fas fa-trash-alt"></i>
                  </a>
                  {% endif %}
                </span>
              </div>
            </li>
            {% endfor %}
          </ul>
        </div>

        <!-- Toast notification for feedback -->
        <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1050">
          <div id="actionToast" class="toast align-items-center text-white bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
              <div class="toast-body" id="toastMessage">
                Action completed successfully.
              </div>
              <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
          </div>
        </div>

        <script>
        document.addEventListener('DOMContentLoaded', function() {
          const toast = document.getElementById('actionToast');
          const toastMessage = document.getElementById('toastMessage');
          
          function showToast(message, isSuccess) {
            toast.classList.remove('bg-success', 'bg-danger');
            toast.classList.add(isSuccess ? 'bg-success' : 'bg-danger');
            toastMessage.textContent = message;
            const bsToast = new bootstrap.Toast(toast);
            bsToast.show();
          }
          
          function attachDeleteHandlers() {
            document.querySelectorAll('.delete-comment').forEach(function(btn) {
              btn.addEventListener('click', function(e) {
                e.preventDefault();
                const commentId = this.getAttribute('data-comment-id');
                const commentElement = document.getElementById('comment-' + commentId);
                
                if (confirm('Are you sure you want to delete this comment?')) {
                  fetch('/delete-comment/' + commentId, {
                    method: 'DELETE',
                    headers: {
                      'Content-Type': 'application/json',
                    }
                  })
                  .then(response => response.json())
                  .then(data => {
                    if (data.success) {
                      // Fade out and remove the comment
                      commentElement.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
                      commentElement.style.opacity = '0';
                      commentElement.style.transform = 'translateX(-20px)';
                      setTimeout(() => {
                        commentElement.remove();
                      }, 300);
                      showToast(data.message, true);
                    } else {
                      showToast(data.error, false);
                    }
                  })
                  .catch(error => {
                    console.error('Error:', error);
                    showToast('An error occurred while deleting the comment.', false);
                  });
                }
              });
            });
          }
          
          // Initial attachment of delete handlers
          attachDeleteHandlers();
          
          // Comment form submission
          const commentForm = document.getElementById('commentForm');
          const submitBtn = document.getElementById('commentSubmitBtn');
          const submitText = document.getElementById('commentSubmitText');
          const submitSpinner = document.getElementById('commentSpinner');
          const commentList = document.getElementById('commentList');
          
          if (commentForm) {
            commentForm.addEventListener('submit', function(e) {
              e.preventDefault();
              
              // Update CKEditor content before submission
              if (typeof CKEDITOR !== 'undefined') {
                for (var instance in CKEDITOR.instances) {
                  CKEDITOR.instances[instance].updateElement();
                }
              }
              
              // Show loading state
              submitBtn.disabled = true;
              submitText.textContent = 'Submitting...';
              submitSpinner.classList.remove('d-none');
              
              const formData = new FormData(commentForm);
              
              fetch(commentForm.action, {
                method: 'POST',
                body: formData,
                headers: {
                  'X-Requested-With': 'XMLHttpRequest'
                }
              })
              .then(response => response.json())
              .then(data => {
                // Reset button
                submitBtn.disabled = false;
                submitText.textContent = 'Submit Comment';
                submitSpinner.classList.add('d-none');
                
                if (data.success) {
                  showToast(data.message, true);
                  
                  // Add the new comment to the list with animation
                  const newComment = document.createElement('li');
                  newComment.id = 'comment-' + data.comment.id;
                  newComment.style.opacity = '0';
                  newComment.style.transform = 'translateY(-20px)';
                  newComment.innerHTML = `
                    <div class="commenterImage">
                      <img src="${data.comment.gravatar}" />
                    </div>
                    <div class="commentText">
                      ${data.comment.text}
                      <span class="date sub-text">
                        ${data.comment.author_name}
                        <a href="#" 
                           class="text-danger ms-2 delete-comment" 
                           data-comment-id="${data.comment.id}"
                           title="Delete comment">
                          <i class="fas fa-trash-alt"></i>
                        </a>
                      </span>
                    </div>
                  `;
                  commentList.appendChild(newComment);
                  
                  // Animate in
                  setTimeout(() => {
                    newComment.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
                    newComment.style.opacity = '1';
                    newComment.style.transform = 'translateY(0)';
                  }, 10);
                  
                  // Clear the CKEditor
                  if (typeof CKEDITOR !== 'undefined') {
                    for (var instance in CKEDITOR.instances) {
                      CKEDITOR.instances[instance].setData('');
                    }
                  }
                  
                  // Re-attach delete handlers for the new comment
                  attachDeleteHandlers();
                  
                } else {
                  showToast(data.error || 'An error occurred.', false);
                }
              })
              .catch(error => {
                console.error('Error:', error);
                showToast('An error occurred. Please try again.', false);
                
                // Reset button
                submitBtn.disabled = false;
                submitText.textContent = 'Submit Comment';
                submitSpinner.classList.add('d-none');
              });
            });
          }
        });
        </script>
      </div>
    </div>
  </div>
</article>

{% include "footer.html" %}
